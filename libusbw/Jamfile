
# This builds the client libraries libusb.lib for libusb-win32,
# and leaves it and usb.h in ../libusbw ready for any
# other component of Argyll to use it.

# If we're MingW, we can actually build the driver and dll too
# by running gmake, but we're not doing so at the moment.

PREF_CCFLAGS 	+= $(CCOPTFLAG) ;		# Turn optimisation on
#PREF_CCFLAGS	+= $(CCDEBUGFLAG) ;		# Debugging flags
PREF_LINKFLAGS	+= $(LINKDEBUGFLAG) ;

if ! $(UNIX) {
	
	NDepends lib : libusb.lib ;
	NDepends libusb.lib : libusb0.def ;
	local LIBUSB_LIB = [ NormDstPaths libusb.lib ] ;
	local LIBUSB0_DEF = [ NormSrcPaths libusb0.def ] ;
	if $(MINGW) {
		GenFileNND libusb.lib : dlltool "-D libusb0.dll -d $(LIBUSB0_DEF) -l $(LIBUSB_LIB)" ;
	} else if $(MSVCDir) {
		GenFileNND libusb.lib : lib "/nologo /machine:i386 /def:$(LIBUSB0_DEF) /out:$(LIBUSB_LIB)" ;
		Clean clean : $(LIBUSB_LIB:S=.exp) ;
	} else {
		EXIT "Unknown compiler !" ;
	}

	# Copy the header file to the libusb directory
	File usb.h : src/usb.h ;

	# Install the DLL to the binary directory
	InstallFile ../bin : libusb0.dll ;

	# Fake x64 versions of files
	File libusb0_x64.sys : libusb0.sys ;
	File libusb0_x64.dll : libusb0.dll ;
}
