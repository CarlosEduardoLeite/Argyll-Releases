
#SubDir TOP spectro ;

CCFLAGS 	+= $(CCOPTFLAG) ;		# Turn optimisation on
#CCFLAGS    += $(CCDEBUGFLAG) ;		# Debugging flags
LINKFLAGS	+= $(LINKDEBUGFLAG) ;

if $(DOS)  { IOFILE = dosio.c ;  }
if $(NT)   { IOFILE = ntio.c ;  }
if $(UNIX) { IOFILE = unixio.c pollem.c ;  }

if $(UNIX) {
  if $(OS) = MACOSX {
	LINKFLAGS += -framework IOKit ;
	LINKFLAGS += -framework CoreFoundation ;
  } else {
	LibWin = /usr/X11R6/lib/libX11.lib 
	         /usr/X11R6/lib/libXxf86vm.lib
	         /usr/X11R6/lib/libXext.lib ;
	LibWinD = /usr/X11R6/lib/ ;
	LibWinH = /usr/X11R6/include/X11 ;
  }
}

if $(OLD_GRETAG) {
	GRETAG_SRC = gretag.c spm.c ; 
} else {
	GRETAG_SRC = ss.c ss_imp.c ; 
}

KEEPOBJS = true ;	# Jam has trouble with multiple users of .obj

#Products
Libraries = libinst ;
Executables = displin dispread dispcal fakeread filmread printread spotread spec2cie ;
Headers = inst.h ;
Samples = ECI2002R.ti2 FograStrip.ti2 ;

#Install
InstallBin $(DOTDOT)$(SLASH)bin : $(Executables)$(SUFEXE) ;
InstallFile $(DOTDOT)$(SLASH)ref : $(Samples) ;
#InstallFile $(DOTDOT)$(SLASH)h : $(Headers) ;
#InstallLib $(DOTDOT)$(SLASH)lib : $(Libraries)$(SUFLIB) ;

# DTP library
Library libinst.lib : inst.c dtp41.c dtp51.c dtp92.c $(GRETAG_SRC) $(IOFILE) ;
ObjectHdrs inst dtp41 dtp51 dtp92 $(GRETAG_SRC) : ../h ../icc ../xicc ;

# Printed target reader program
Main printread : printread.c ../target/alphix.c ;
ObjectHdrs printread : ../h ../cgats ../icc ../numlib ../xicc ../target ;
LinkLibraries printread : libinst.lib ../cgats/libcgats.lib
                          ../xicc/libxicc.lib ../xicc/libxcolorants.lib
                          ../numlib/libnum.lib ../icc/libicc.lib ../plot/libplot.lib ;

# Printed target spot reader utility
Main spotread : spotread.c ;
ObjectHdrs spotread : ../h ../cgats ../icc ../numlib ../rspl ../xicc ../gamut ../spectro ;
LinkLibraries spotread : libinst.lib  ../plot/libplot.lib
                          ../numlib/libnum.lib ../rspl/librspl.lib ../xicc/libxicc.lib
                          ../icc/libicc.lib ../gamut/libgamut.lib ../cgats/libcgats.lib ;

# Gretag Spectroscan/T filmstrip reader
Main filmread : filmread.c ;
ObjectHdrs filmread : ../h ../cgats ../icc ../numlib ../xicc ;
LinkLibraries filmread : libinst.lib ../cgats/libcgats.lib ../xicc/libxicc.lib
                          ../numlib/libnum.lib ../icc/libicc ../plot/libplot.lib ;

# Create linear .cal
Main displin : displin.c ;
ObjectHdrs displin : ../h ../cgats ../numlib ;
LinkLibraries displin : ../cgats/libcgats.lib ../numlib/libnum.lib ;

# Display calibration program
Main dispcal : dispcal.c dispwin.c ../target/ofps.c moncurve.c dispsup.c ;
ObjectHdrs dispcal dispwin dispsup ../target/ofps : ../h ../cgats ../icc
                           ../numlib ../rspl ../xicc ../target ../plot ;
LinkLibraries dispcal : libinst.lib ../cgats/libcgats.lib
                         ../xicc/libxicc.lib  ../icc/libicc.lib
                         ../numlib/libnum.lib ../rspl/librspl.lib
                         ../plot/libplot.lib $(LibWin) ;

# Display tester program
Main dispread : dispread.c dispwin.c dispsup.c ;
ObjectHdrs dispread dispwin dispsup : ../h ../cgats ../icc ../numlib ../xicc ;
LinkLibraries dispread : libinst.lib ../cgats/libcgats.lib
                         ../xicc/libxicc.lib  ../icc/libicc.lib
                         ../numlib/libnum.lib ../plot/libplot.lib $(LibWin) ;


#display test window standalone test
Object sa_dispwin$(SUFOBJ) : dispwin.c ;
ObjectHdrs sa_dispwin : ../h ../numlib ../cgats ;
MainFromObjects dispwin : sa_dispwin$(SUFOBJ) ;
ObjectCcFlags sa_dispwin.c : -DSTANDALONE_TEST ;
LinkLibraries dispwin : ../numlib/libnum.lib ../cgats/libcgats.lib $(LibWin) ;

# Fake device print/read utility using ICC profile
Main fakeread : fakeread.c ;
ObjectHdrs fakeread : ../h ../cgats ../xicc ../spectro ../rspl ../numlib ../gamut ../icc ;	# icc bug workaround
LinkLibraries fakeread : libinst.lib ../icc/libicc.lib
                        ../xicc/libxicc.lib ../xicc/libxcolorants.lib
						../gamut/libgamut.lib ../cgats/libcgats.lib
                        ../rspl/librspl.lib ../numlib/libnum.lib ;

# Add CIE values to a spectral reading file
Main spec2cie : spec2cie.c ;
ObjectHdrs spec2cie : ../h ../cgats ../xicc ../spectro ../rspl ../numlib ../gamut ../icc ;	
LinkLibraries spec2cie : libinst.lib ../icc/libicc.lib
                        ../xicc/libxicc.lib ../xicc/libxcolorants.lib
						../gamut/libgamut.lib ../numlib/libnum.lib
                        ../cgats/libcgats.lib ;

# Test utility for moncurve
Main monctest : monctest.c moncurve.c ;
ObjectHdrs monctest : ../h ../numlib ../plot ;	# icc bug workaround
LinkLibraries monctest : ../numlib/libnum.lib ../plot/libplot.lib $(LibWin) ;

# Support for monotonic curves for dispcal
ObjectHdrs moncurve : ../h ../numlib ;

# Dumy ti3 file generator for testing
#Main dumyti3 : dumyti3.c ;
#ObjectHdrs dumyti3 : ../h ../cgats ;	# icc bug workaround
#LinkLibraries dumyti3 : ../cgats/libcgats.lib ;

# Experimental RAMDAC loader
# Main vgamma : vgamma.c ;

# fp conversion code test
#Main fp : fp.c ;

# Gretag test harness relies on X11/GL libs
if $(OLD_GRETAG) && $(UNIX) && $(OS) != MACOSX {
	# test gretag interface
	Object gt_gretag$(SUFOBJ) : gretag.c ;
	ObjectCcFlags gt_gretag.c : -DSTANDALONE_TEST ;
    ObjectHdrs gt_gretag.c : ../h ../icc ../xicc ;
	MainFromObjects gt_test : gt_gretag$(SUFOBJ) spm$(SUFOBJ) $(IOFILE:S=$(SUFOBJ)) ;
	LinkLibraries gt_test : libinst.lib ../xicc/libxicc.lib ../cgats/libcgats.lib ../icc/libicc.lib ;
	LINKFLAGS on gt_test += -L$(LibWinD) ;
	LINKLIBS on gt_test += -lglut -lGL -lGLU -lX11 -lXext -lXmu -lXi -lm ;
}

